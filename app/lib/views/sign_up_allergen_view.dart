import 'package:flutter/material.dart';
import 'package:nomnom_safe/services/allergen_service.dart';
import 'package:nomnom_safe/widgets/multi_select_checkbox_list.dart';

class SignUpAllergenView extends StatefulWidget {
  final bool isLoading;
  final List<String> selectedAllergenIds;
  final ValueChanged<List<String>> onChanged;
  final VoidCallback onBack;
  final VoidCallback onSubmit;

  const SignUpAllergenView({
    super.key,
    required this.isLoading,
    required this.selectedAllergenIds,
    required this.onChanged,
    required this.onBack,
    required this.onSubmit,
  });

  @override
  State<SignUpAllergenView> createState() => _SignUpAllergenViewState();
}

class _SignUpAllergenViewState extends State<SignUpAllergenView> {
  Map<String, String> allergenIdToLabel = {};
  Map<String, String> _allergenLabelToId = {};
  Set<String> _selectedAllergenLabels = {};
  bool isLoadingAllergens = true;
  String? allergenError;

  @override
  void initState() {
    super.initState();
    _loadAllergens();
  }

  Future<void> _loadAllergens() async {
    try {
      final idToLabel = await AllergenService().getAllergenIdToLabelMap();
      final labelToId = await AllergenService().getAllergenLabelToIdMap();
      final selectedLabels = await AllergenService().idsToLabels(
        widget.selectedAllergenIds,
      );

      if (mounted) {
        setState(() {
          allergenIdToLabel = idToLabel;
          _allergenLabelToId = labelToId;
          _selectedAllergenLabels = selectedLabels.toSet();
          isLoadingAllergens = false;
        });
      }
    } catch (e) {
      if (mounted) {
        setState(() {
          allergenError = "Error loading allergens.";
          isLoadingAllergens = false;
        });
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    if (isLoadingAllergens) {
      return const Center(child: CircularProgressIndicator());
    }
    if (allergenError != null) {
      return Center(
        child: Text(
          allergenError!,
          style: TextStyle(color: Theme.of(context).colorScheme.error),
        ),
      );
    }
    if (allergenIdToLabel.isEmpty && !isLoadingAllergens) {
      return const Center(child: Text('No allergens available'));
    }

    return Column(
      children: [
        MultiSelectCheckboxList(
          options: allergenIdToLabel.values.toList(),
          selected: _selectedAllergenLabels,
          onChanged: (label, checked) {
            final id = _allergenLabelToId[label];
            if (id == null) return;

            final updated = widget.selectedAllergenIds.toSet();
            if (checked) {
              updated.add(id);
            } else {
              updated.remove(id);
            }

            setState(() {
              _selectedAllergenLabels = updated
                  .map((id) => allergenIdToLabel[id] ?? id)
                  .toSet();
            });

            widget.onChanged(updated.toList());
          },
        ),
        const SizedBox(height: 24),
        ElevatedButton(
          onPressed: widget.isLoading ? null : widget.onSubmit,
          child: widget.isLoading
              ? const Center(child: CircularProgressIndicator())
              : const Text('Create Account'),
        ),
        TextButton(onPressed: widget.onBack, child: const Text('Back')),
      ],
    );
  }
}
