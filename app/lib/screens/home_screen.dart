import 'package:flutter/material.dart';
import 'package:nomnom_safe/services/service_utils.dart';
import 'package:nomnom_safe/models/restaurant.dart';
import 'package:nomnom_safe/models/user.dart';
import 'package:nomnom_safe/widgets/restaurant_card.dart';
import 'package:nomnom_safe/services/allergen_service.dart';
import 'package:nomnom_safe/services/restaurant_service.dart';
import 'package:nomnom_safe/utils/allergen_utils.dart';
import 'package:nomnom_safe/widgets/filter_modal.dart';
import 'package:nomnom_safe/utils/restaurant_utils.dart';
import 'package:nomnom_safe/services/auth_service.dart';
import 'package:nomnom_safe/nav/route_tracker.dart';

/// Main screen displaying allergen filters and a list of restaurants
class HomeScreen extends StatefulWidget {
  final RestaurantService? restaurantService;
  final AllergenService? allergenService;
  final User? injectedCurrentUser;
  final bool useInjectedCurrentUser;

  const HomeScreen({
    super.key,
    this.restaurantService,
    this.allergenService,
    this.injectedCurrentUser,
    this.useInjectedCurrentUser = false,
  });

  @override
  State<HomeScreen> createState() => _HomeScreenState();
}

class _HomeScreenState extends State<HomeScreen> with RouteAware {
  // Service classes
  late AllergenService _allergenService;
  late RestaurantService _restaurantService;

  // State variables
  bool isLoadingRestaurants = true; // controls loading spinner visibility
  Map<String, String> allergenIdToLabel = {};
  Map<String, String> _allergenLabelToId = {};
  Set<String> _selectedAllergenIds =
      {}; // store IDs instead of Allergen objects
  Set<String> _selectedAllergenLabels = {}; // cached labels for display
  bool isLoadingAllergens = true;
  String? allergenError;
  List<Restaurant> unfilteredRestaurants = []; // all restaurants from Firestore
  List<Restaurant> restaurantList = []; // restaurants to be displayed
  List<String> selectedCuisines = [];
  List<String> availableCuisines = [];

  @override
  void didChangeDependencies() {
    super.didChangeDependencies();
    routeObserver.subscribe(this, ModalRoute.of(context)! as PageRoute);
    _allergenService = getAllergenService(context);

    if (isLoadingAllergens) {
      _fetchAllergens();
    }
  }

  @override
  void initState() {
    super.initState();

    // allow optional injection for tests
    _restaurantService = (widget.restaurantService ?? RestaurantService());

    // Load restaurants when the widget is first built
    _fetchUnfilteredRestaurants();
  }

  @override
  void dispose() {
    routeObserver.unsubscribe(this);
    super.dispose();
  }

  @override
  void didPopNext() {
    // User returned from ProfileScreen
    _fetchAllergens(); // refresh selection
  }

  /// Fetch allergen labels and update the state if the widget is still mounted
  Future<void> _fetchAllergens() async {
    try {
      final idToLabel = await _allergenService.getAllergenIdToLabelMap();
      final labelToId = await _allergenService.getAllergenLabelToIdMap();
      final selectedLabels = await _allergenService.idsToLabels(
        _selectedAllergenIds.toList(),
      );

      if (mounted) {
        setState(() {
          allergenIdToLabel = idToLabel;
          _allergenLabelToId = labelToId;
          isLoadingAllergens = false;
          _selectedAllergenLabels = selectedLabels.toSet();
        });
      }
      _applyUserAllergensIfLoggedIn();
    } catch (e) {
      if (mounted) {
        setState(() {
          allergenError = "Error loading allergens.";
          isLoadingAllergens = false;
        });
      }
    }
  }

  void _applyUserAllergensIfLoggedIn() async {
    final user = widget.useInjectedCurrentUser
        ? widget.injectedCurrentUser
        : AuthService().currentUser;
    if (user == null) {
      return;
    }

    final userAllergenIds = user.allergies.toSet();

    if (userAllergenIds.isNotEmpty) {
      final labels = await _allergenService.idsToLabels(
        userAllergenIds.toList(),
      );
      setState(() {
        _selectedAllergenIds = userAllergenIds;
        _selectedAllergenLabels = labels.toSet();
      });
      _applyAllergenFilter();
    }
  }

  /// Fetch all restaurants without any filters
  void _fetchUnfilteredRestaurants() async {
    setState(() {
      isLoadingRestaurants = true;
    });

    final allRestaurants = await _restaurantService.getAllRestaurants();
    if (mounted) {
      setState(() {
        unfilteredRestaurants = allRestaurants;
        restaurantList = allRestaurants;
        _extractAvailableCuisines();
        isLoadingRestaurants = false;
      });
    }
  }

  void _extractAvailableCuisines() {
    setState(() {
      availableCuisines = extractAvailableCuisines(restaurantList);
    });
  }

  void _filterRestaurantsByCuisine(List<String> cuisines) {
    setState(() {
      selectedCuisines = cuisines;
      restaurantList = filterRestaurantsByCuisine(
        unfilteredRestaurants,
        cuisines,
      );
    });
  }

  /// Apply the allergen filter to the restaurant list
  Future<void> _applyAllergenFilter() async {
    if (_selectedAllergenIds.isEmpty) {
      setState(() {
        restaurantList = unfilteredRestaurants;
        _extractAvailableCuisines();
      });
      return;
    }

    setState(() {
      isLoadingRestaurants = true;
    });

    final filteredRestaurants = await _restaurantService
        .filterRestaurantsFromList(
          unfilteredRestaurants,
          _selectedAllergenIds.toList(),
        );

    if (mounted) {
      setState(() {
        restaurantList = filteredRestaurants;
        _extractAvailableCuisines();
        isLoadingRestaurants = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Padding(
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
          child: Row(
            children: [
              // Allergen Filter
              Expanded(
                child: isLoadingAllergens
                    ? // Show a loading spinner if allergens havenâ€™t loaded yet
                      Center(child: CircularProgressIndicator())
                    : allergenError != null
                    ? Text(
                        allergenError!,
                        style: TextStyle(
                          color: Theme.of(context).colorScheme.error,
                        ),
                      )
                    : // Show the allergen filter widget once allergens are loaded
                      FilterModal(
                        buttonLabel: 'Allergens',
                        title: 'Filter by Allergen',
                        options: allergenIdToLabel.values.toList(),
                        selectedOptions: _selectedAllergenIds
                            .map((id) => allergenIdToLabel[id] ?? id)
                            .toList(),
                        onChanged: (selectedLabels) {
                          final matchedIds = selectedLabels
                              .map((label) => _allergenLabelToId[label])
                              .where((id) => id != null)
                              .cast<String>()
                              .toSet();

                          setState(() {
                            _selectedAllergenIds = matchedIds;
                            _selectedAllergenLabels = selectedLabels.toSet();
                          });
                          _applyAllergenFilter();
                        },
                      ),
              ),
              const SizedBox(width: 12), // spacing between filters
              // Cuisine Filter
              if (!(_selectedAllergenIds.isNotEmpty &&
                      restaurantList.isEmpty) &&
                  availableCuisines.isNotEmpty)
                Expanded(
                  child: FilterModal(
                    buttonLabel: 'Cuisines',
                    title: 'Filter by Cuisine',
                    options: availableCuisines,
                    selectedOptions: selectedCuisines,
                    onChanged: _filterRestaurantsByCuisine,
                  ),
                ),
            ],
          ),
        ),
        Padding(
          padding: const EdgeInsets.symmetric(vertical: 4, horizontal: 12),
          child: Text(
            _selectedAllergenIds.isNotEmpty
                ? "The following restaurants offer at least one menu item that doesn't contain ${formatAllergenList(_selectedAllergenLabels.toList(), "or")}:"
                : "No allergens selected.",
          ),
        ),
        // Make the restaurant list take up remaining space
        Expanded(
          child: isLoadingRestaurants
              ? // Show a loading spinner while restaurants are loading
                const Center(child: CircularProgressIndicator())
              : restaurantList.isEmpty
              ? // No restaurants match the filters
                const Center(child: Text('No restaurants match your filters'))
              : // Restaurant list
                ListView.builder(
                  padding: const EdgeInsets.only(bottom: 12),
                  itemCount: restaurantList.length,
                  itemBuilder: (context, index) {
                    return RestaurantCard(restaurant: restaurantList[index]);
                  },
                ),
        ),
      ],
    );
  }
}
